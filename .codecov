#!/bin/bash
#
# This script is supposed to be source'd prior to building the library and samples using GNU GCC.
# Executing "eval ${COVERAGE} (after building/running a case) yields code coverage information.
# Prerequisite: source .env
#
FIND=$(which find)
GCOV=$(which gcov)

EFLAGS="--coverage" ELDFLAGS="--coverage"

# count number of times the script got source'd
if [[ "${COVID}" != "" ]]; then
  COVID=$((COVID+1))
else
  COVID=1
fi

if [[ "${TRAVIS_BUILD_DIR}" != "" ]]; then
  RUNGCOV="(CWD=\${PWD} && for FILE in \$(${FIND} ${TRAVIS_BUILD_DIR} -type f -name '*.gcno'); do \
      FILENAME=\$(basename \${FILE} .gcno).o; \
      FILEPATH=\$(echo \${FILE} | sed -e 's/\(.\+\)build.\+/\1/g'); \
      BUILD=\$(dirname \${FILE} | sed -e 's/^.\+\(build.*\)/\1/g'); \
      cd \${FILEPATH}; \
      ${GCOV} -o \${BUILD} -pb \${FILENAME}; \
    done && \
    mkdir -p ${TRAVIS_BUILD_DIR}/codecov/${COVID} && \
    ${FIND} ${TRAVIS_BUILD_DIR} -not \( -path ${TRAVIS_BUILD_DIR}/codecov -prune \) -type f -name '*.gcov' \
      -exec mv {} ${TRAVIS_BUILD_DIR}/codecov/${COVID} \; && \
    cd \${CWD})"
  CODECOV="codecov"
else
  echo "Please run \"source .env\" first!"
fi

