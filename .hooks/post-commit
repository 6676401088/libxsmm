#!/bin/sh

VERSIONFILE=${GIT_DIR}/../version.txt
LOCKFILE=${GIT_DIR}/.commit

if [[ -e ${LOCKFILE} ]] ; then
  ECHO=$(which echo)
  GREP=$(which grep)
  GIT=$(which git)
  CUT=$(which cut)
  RM=$(which rm)

  MAIN=$(${GIT} describe --tags --abbrev=0)
  REVC=$(${GIT} describe --tags | ${CUT} -d- -f2)
  VERSION=${MAIN}-${REVC}

  # update version file
  ${ECHO} ${VERSION} > ${VERSIONFILE}

  # lock file must be deleted *prior* to below commit
  ${RM} ${LOCKFILE}

  UPDATE=$(${GIT} diff --name-only | ${GREP} ${VERSIONFILE} ; ${ECHO} $?)
  if [[ "0" != "${UPDATE}" ]] ; then
    ${GIT} add ${VERSIONFILE}
    ${GIT} commit --amend -C HEAD --no-verify
  fi
fi
